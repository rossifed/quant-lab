services:
  # Infrastructure
  redpanda:
    image: redpandadata/redpanda:latest
    container_name: redpanda
    command: >
      redpanda start
        --overprovisioned
        --smp 1
        --memory 512M
        --reserve-memory 0M
        --node-id 0
        --check=false
        --kafka-addr PLAINTEXT://0.0.0.0:9092
        --advertise-kafka-addr PLAINTEXT://redpanda:9092
    ports:
      - "9092:9092"   # Kafka port
      - "9644:9644"   # Admin API
    networks:
      - quant-lab-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9644/v1/status/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ray Cluster - Compute Layer
  ray-head:
    image: rayproject/ray:2.39.0-py312
    container_name: ray-head
    command: >
      ray start --head
        --port=6379
        --dashboard-host=0.0.0.0
        --dashboard-port=8265
        --num-cpus=6
        --block
    ports:
      - "8265:8265"   # Ray Dashboard
      - "10001:10001" # Ray Client
    networks:
      - quant-lab-net
    shm_size: 2gb
    healthcheck:
      test: ["CMD", "ray", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Microservices
  optimization:
    build: 
      context: .
      dockerfile: ./services/optimization/Dockerfile
    container_name: optimization-service
    ports:
      - "8001:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - KAFKA_TOPIC=optimization-events
      - KAFKA_GROUP_ID=optimization-group
      - LOG_LEVEL=INFO
      - RAY_ADDRESS=ray://ray-head:10001
    depends_on:
      redpanda:
        condition: service_healthy
      ray-head:
        condition: service_healthy
    networks:
      - quant-lab-net
    restart: unless-stopped

  backtesting:
    build:
      context: .
      dockerfile: ./services/backtesting/Dockerfile
    container_name: backtesting-service
    ports:
      - "8002:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - KAFKA_TOPIC=backtesting-events
      - KAFKA_GROUP_ID=backtesting-group
      - LOG_LEVEL=INFO
    depends_on:
      redpanda:
        condition: service_healthy
    networks:
      - quant-lab-net
    restart: unless-stopped

networks:
  quant-lab-net:
    driver: bridge
